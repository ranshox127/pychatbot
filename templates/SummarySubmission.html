<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summary Submissions</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
    <h1>Summary Submissions</h1>
    <div id="submissionsContainer" class="container-fluid">
        <!-- Submissions will be populated by JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetch('https://chatbot.moocs.tw:8096/api/summarysubmissions')
                .then(response => response.json())
                .then(data => {
                    const submissionsContainer = document.getElementById('submissionsContainer');
                    data.forEach(submission => {
                        let card = document.createElement('div');
                        card.className = 'card mb-3';
                        let cardRow = document.createElement('div');
                        cardRow.className = 'row no-gutters';
                        card.appendChild(cardRow);

                        let leftCol = document.createElement('div');
                        leftCol.className = 'col-md-9';
                        cardRow.appendChild(leftCol);

                        // Details for left column
                        ['Submission ID', 'Student ID', 'Class name', 'Unit ID', 'Student summary content', 'Submit Time', 'Verify status', 'Keyword-based feedback'].forEach((title, index) => {
                            let detailRow = document.createElement('div');
                            detailRow.className = 'row';
                            let detailTitle = document.createElement('div');
                            detailTitle.className = 'col-3 text-left font-weight-bold';
                            detailTitle.textContent = title;
                            let detailText = document.createElement('div');
                            detailText.className = 'col-9 text-left';
                            detailText.textContent = submission[index];

                            detailRow.appendChild(detailTitle);
                            detailRow.appendChild(detailText);
                            leftCol.appendChild(detailRow);
                        });

                        let feedbackRow = document.createElement('div');
                        feedbackRow.className = 'row';
                        let feedbackTitle = document.createElement('div');
                        feedbackTitle.className = 'col-3 text-left font-weight-bold';
                        feedbackTitle.textContent = 'Concept feedback generated by GenAI';
                        let feedbackText = document.createElement('div');
                        feedbackText.className = 'col-9 text-left';
                        let feedbackInput = document.createElement('textarea');
                        feedbackInput.value = submission[8];
                        feedbackInput.className = 'form-control';
                        feedbackInput.setAttribute('rows', '8');
                        feedbackInput.dataset.submissionId = submission[0];
                        feedbackText.appendChild(feedbackInput);
                        feedbackRow.appendChild(feedbackTitle);
                        feedbackRow.appendChild(feedbackText);
                        leftCol.appendChild(feedbackRow);

                        let rightCol = document.createElement('div');
                        rightCol.className = 'col-md-3';
                        cardRow.appendChild(rightCol);

                        let checklistDiv = document.createElement('div');
                        checklistDiv.className = 'checklist p-3';
                        rightCol.appendChild(checklistDiv);

                        let checklistQuestions = [
                            '這份回饋沒有呈現得很詳細且精確',
                            '這份回饋難以讓大多數人快速理解這些解釋',
                            '這份回饋需要其他支援才能理解',
                            '這份回饋中有不一致之處',
                            '這份回饋未包含足夠的訊息讓我理解'
                        ];

                        checklistQuestions.forEach((question, index) => {
                            let checkboxContainer = document.createElement('div');
                            checkboxContainer.className = 'form-check';
                            let checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'form-check-input';
                            checkbox.id = 'check' + index + '-' + submission[0];
                            checkbox.value = '1'; // Value if checked
                            checkbox.dataset.uncheckedValue = '0'; // Value if unchecked

                            let label = document.createElement('label');
                            label.className = 'form-check-label';
                            label.htmlFor = checkbox.id;
                            label.textContent = question;

                            checkboxContainer.appendChild(checkbox);
                            checkboxContainer.appendChild(label);
                            checklistDiv.appendChild(checkboxContainer);
                        });

                        let saveButton = document.createElement('button');
                        saveButton.textContent = 'Save';
                        saveButton.className = 'btn btn-primary mt-2';
                        saveButton.dataset.submissionId = submission[0];
                        saveButton.dataset.TopicId = submission[3];
                        saveButton.dataset.contextTitle = submission[2];
                        saveButton.dataset.basic_feedback = submission[7];
                        saveButton.dataset.lineId = submission[10];
                        saveButton.onclick = saveFeedback;
                        rightCol.appendChild(saveButton);

                        submissionsContainer.appendChild(card);
                    });
                })
                .catch(error => console.error('Error:', error));
        });

        function saveFeedback(event) {
            let submissionId = event.target.dataset.submissionId;
            let TopicId = event.target.dataset.TopicId;
            let contextTitle = event.target.dataset.contextTitle; // Retrieve context_title
            let lineId = event.target.dataset.lineId;
            let basic_feedback = event.target.dataset.basic_feedback;
            let feedbackTextarea = document.querySelector(`textarea[data-submission-id='${submissionId}']`);
            let updatedFeedback = basic_feedback + "\n" + feedbackTextarea.value;
            let checklistItems = document.querySelectorAll(`input[type='checkbox'][id^='check'][id$='${submissionId}']`);
            let checklistValues = Array.from(checklistItems).map(checkbox => checkbox.checked ? 1 : 0);

            // Prepare the data to update the SummarySubmissions table
            let summarySubmissionData = {
                verify_status: 'complete_review'
            };

            // Prepare the data to insert into the TeacherFeedbacks table
            let teacherFeedbackData = {
                SubmissionId: submissionId,
                SubmissionType: 'Summary',
                Feedback: updatedFeedback,
                FeedbackTime: new Date().toISOString().slice(0, 19).replace('T', ' '),
                context_title: contextTitle,
                LineID: lineId
            };

            // Step 1: Update SummarySubmissions table
            fetch('https://chatbot.moocs.tw:8096/api/summarysubmissions/' + submissionId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(summarySubmissionData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log('SummarySubmissions updated:', data);

                    // Step 2: Insert into TeacherFeedbacks table and get the inserted FeedbackId
                    return fetch('https://chatbot.moocs.tw:8096/api/teacherfeedbacks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(teacherFeedbackData)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    console.log('TeacherFeedback inserted:', data);
                    let feedbackId = data.FeedbackId; // This should be returned from your server

                    // Step 3: Insert into FeedbackEvaluations table
                    let feedbackEvaluationData = {
                        type: 'summary', // Specify the feedback type as 'code'
                        FeedbackId: feedbackId,
                        Accuracy: checklistValues[0],
                        Readability: checklistValues[1],
                        Clarity: checklistValues[2],
                        Consistency: checklistValues[3],
                        Answerability: checklistValues[4]
                    };

                    return fetch('https://chatbot.moocs.tw:8096/api/feedbackevaluations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(feedbackEvaluationData)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    console.log('FeedbackEvaluations inserted:', data);

                    // Step 4: Send feedback to Line user
                    let lineFeedbackData = {
                        line_userID: lineId,
                        feedback: "以下是" + TopicId + "總結的回饋\n\n" + updatedFeedback // 自定義消息
                    };

                    return fetch('https://chatbot.moocs.tw:8096/api/send-feedback/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(lineFeedbackData)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    console.log('FeedbackEvaluations inserted:', data);
                    alert('Feedback and evaluations saved successfully!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving feedback and evaluations.');
                });
        }

    </script>
</body>

</html>